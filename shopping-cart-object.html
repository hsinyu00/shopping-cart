<!DOCTYPE html>
<html>
<head>
<title>SHOPPING CART</title>
<meta charset='utf8'>
<style>
    table,th,td {
        border:1px solid #aaa;
    }
    hr {
        border: 0;
        height: 1px;
        background-color: #eee;
    }
    .prod-img {
        float: left;
        margin-right: 20px;
        width: 200px;
        height: 200px;
    }
    .clearfix:before, .clearfix:after {
        content: " ";
        display: table;
    }
    .clearfix:after {
        clear: both;
    }
    #emptyCart {
        margin-top: 20px;
    }
</style>
</head>
<body>
    <h2>Products</h2>
    <div id="products">

    </div>
    <h2>My Shopping Cart</h2>
    <div id="cart">
    No item in cart.
    </div>
    <button id="emptyCart">clear cart</button>

<script>

function Cart(){
    var self = this;
    self.products = [];
    self.cartItems = [];

    function grabRespond(respond, self){
        self.products = respond;
        displayProducts("products", respond);
    }

    /*
    render catalog template
    */
    function displayProducts(node, prodData){
        var node = document.getElementById(node)
        for(i = 0; i < prodData.length; i++){
            var item = document.createElement("div");
            item.classList.add("clearfix");
            item.setAttribute("id", prodData[i].id);
            var img = document.createElement("img");
            img.src = prodData[i].image;
            img.classList.add("prod-img");
            item.appendChild(img);
            var pid = document.createElement("p");
            pid.textContent = prodData[i].id;
            item.appendChild(pid);
            var pname = document.createElement("p");
            pname.textContent = prodData[i].name;
            item.appendChild(pname);
            var price = document.createElement("p");
            price.textContent = prodData[i].price;
            item.appendChild(price);
            var btn = document.createElement("button");
            btn.classList.add("add-to-cart");
            btn.setAttribute("data-id", prodData[i].id);
            btn.textContent = "Add to cart";
            btn.addEventListener("click", addtoCart, false);
            item.appendChild(btn);
            node.appendChild(item);
            var hr = document.createElement("hr");
            node.appendChild(hr);
        }
    }

    function addtoCart(e){
        var targetId = e.target.getAttribute('data-id'),
            targetItem = {};
        for (var i = 0; i < self.products.length; i++){
          if (self.products[i].id === targetId){
              targetItem.id = self.products[i].id;
              targetItem.name = self.products[i].name;
              targetItem.price = self.products[i].price;
          }
        }
        // check if product already in cart
        if(self.cartItems.length > 0) {
            var cartlen = self.cartItems.length;
            var inCart = false;
            for(i = 0; i < cartlen; i++){
                if(self.cartItems[i].id === targetId) { // cart 內已有此商品
                    if(self.cartItems[i].quantity < 4) {
                        self.cartItems[i].quantity+=1;
                    }
                    else {
                        alert("每項商品最多買4個");
                    }
                    inCart = true;
                    break;
                }
            }
            // cart 內沒有此商品
            if(inCart === false) {
                self.cartItems.push(targetItem);
                self.cartItems[i].quantity = 1;
            }
        } else { // 購物車是空的
            self.cartItems.push(targetItem);
            self.cartItems[0].quantity = 1;
        }

        updateCart('cart', self.cartItems);
    }

    /*
    render cart template
    */
    function updateCart(node, cartData){
        var node = document.getElementById(node);
        node.innerHTML = "";
        for(i = 0; i < cartData.length; i++){
            var item = document.createElement("tr");
            for(key in cartData[i]) {
                var theAttr = document.createElement("td");
                theAttr.classList.add(key);
                theAttr.textContent = cartData[i][key];
                item.appendChild(theAttr);
            }
            name.textContent = cartData[i].name;
            item.setAttribute("id", "cart-product" + (i+1));
            node.appendChild(item);
        }
    }

    this.loadProducts = function(file){
        var request = new XMLHttpRequest();
        if (!request) {
          alert('Giving up :( Cannot create an XMLHTTP instance');
          return false;
        }
        request.onreadystatechange = ajaxLoad;
        request.open('GET', file);
        request.send();

        function ajaxLoad() {
            if (request.readyState === 4) {
                if (request.status === 200) {
                    var prod = JSON.parse(request.responseText);
                    grabRespond(prod, self);
                } else {
                    alert('There was a problem with the request.');
                    return false;
                }
            }
        }
    }


}

var myCart = new Cart();
myCart.loadProducts('products2.json');

</script>
</body>
</html>
